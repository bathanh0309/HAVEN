# HAVEN Hierarchical Security System Configuration
# Version: 3.0 - Single Registration Point (Cam1)

# ============================================================
# SYSTEM ARCHITECTURE
# ============================================================
# Cam1 (Cng): REGISTRATION MASTER - Ch cam1 ng k ID mi
# Cam2 (Bi xe): VERIFICATION - Check registry, cnh bo UNK
# Cam3 (Thang my): VERIFICATION - Check registry, cnh bo UNK
# Cam4 (Phng): STRICT VERIFICATION - Check registry, cnh bo INTRUDER

# ============================================================
# DATA SOURCE CONFIGURATION
# ============================================================
data:
  # Root directory containing camera folders
  data_root: "D:/HAVEN/backend/data/multi-camera"
  
  # Camera definitions
  cameras:
    - id: 1
      name: "cam1_gate"
      role: "registration"  #  REGISTRATION MASTER
      enabled: true
      source_type: "video_folder"
      path: "cam1"  # Folder cha videos cam1
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0
      
      # Face detection requirements for Cam1
      face_detection:
        enabled: true
        min_face_size: 100  # Minimum face size (pixels)
        min_face_confidence: 0.8  # Face detection confidence
        frontal_angle_threshold: 30  # Degrees from frontal
        
    - id: 2
      name: "cam2_parking"
      role: "verification"  #  VERIFICATION ONLY
      enabled: true
      source_type: "video_folder"
      path: "cam2"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0
      
    - id: 3
      name: "cam3_elevator"
      role: "verification"  #  VERIFICATION ONLY
      enabled: true
      source_type: "video_folder"
      path: "cam3"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0
      
    - id: 4
      name: "cam4_room"
      role: "strict_verification"  #  STRICT - Cnh bo xm nhp
      enabled: true
      source_type: "video_folder"
      path: "cam4"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0

# ============================================================
# REGISTRATION & VERIFICATION RULES
# ============================================================
registration:
  # Only cam1 can register new IDs
  registration_camera: 1  #  Cam1 ONLY!
  
  # Face quality requirements for registration (Cam1)
  face_quality:
    min_sharpness: 50  # Laplacian variance
    min_brightness: 30  # Mean pixel intensity
    max_brightness: 220
    frontal_angle_max: 30  # Degrees from frontal view
    min_face_width: 100  # Pixels
    min_face_height: 100
    
  # Registered ID format
  id_prefix: ""  # Empty = just numbers: 1, 2, 3, ...
  id_start: 1
  
  # Unknown person tracking
  unknown:
    enabled: true
    prefix: "UNK"  # UNK1, UNK2, UNK3, ...
    start: 1
    
  # Intruder alert (Cam4)
  intruder_alert:
    enabled: true
    label: "INTRUDER"
    sound_alert: true  # Beep when detected
    log_to_file: true

# ============================================================
# CAMERA GRAPH - Spatiotemporal Constraints
# ============================================================
camera_graph:
  # Transition times between cameras (seconds)
  transitions:
    1:  # Cam1 (Gate)  others
      2: {min_time: 10, max_time: 120}   # 10s-2min to parking
      3: {min_time: 60, max_time: 300}   # 1-5min to elevator
      4: {min_time: 120, max_time: 600}  # 2-10min to room
    2:  # Cam2 (Parking)  others
      1: {min_time: 10, max_time: 120}
      3: {min_time: 30, max_time: 180}   # 30s-3min to elevator
      4: {min_time: 60, max_time: 300}   # 1-5min to room
    3:  # Cam3 (Elevator)  others
      1: {min_time: 60, max_time: 300}
      2: {min_time: 30, max_time: 180}
      4: {min_time: 5, max_time: 60}     # 5s-1min to room (close)
    4:  # Cam4 (Room)  others
      1: {min_time: 120, max_time: 600}
      2: {min_time: 60, max_time: 300}
      3: {min_time: 5, max_time: 60}

# ============================================================
# DETECTION & TRACKING
# ============================================================
detection:
  yolo:
    model_path: "backend/models/yolov11n.pt"
    conf_threshold: 0.5
    iou_threshold: 0.45
    device: "cuda"
    img_size: 640
    classes: [0]  # person only
    
  # Face detection (for Cam1 registration)
  face:
    enabled: true
    model: "retinaface"  # or "mtcnn"
    min_confidence: 0.8
    
tracking:
  tracker_type: "bytetrack"
  min_tracklet_frames: 5
  max_age: 30
  min_hits: 3
  iou_threshold: 0.3

# ============================================================
# REID CONFIGURATION
# ============================================================
reid:
  # Feature extraction
  features:
    face:
      enabled: true  #  REQUIRED for Cam1 registration
      model_path: "models/arcface_r100.pth"
      weight: 1.0  # Highest priority
      
    gait:
      enabled: false
      weight: 0.7
      
    appearance:
      enabled: true
      model_path: null
      weight: 0.5
  
  # Matching thresholds
  thresholds:
    # For registered persons (green box)
    registered_match: 0.70  # Similarity >= 0.70 = match to registry
    
    # For unknown persons (red box)
    unknown_threshold: 0.60  # Similarity < 0.60 = definitely unknown
    
    # Margin between candidates
    margin: 0.15
  
  # Similarity metric
  similarity_metric: "cosine"
  
  # Embedding update
  update_method: "ema"
  ema_alpha: 0.3
  
  # Quality gating
  quality:
    min_tracklet_frames: 5
    min_quality_score: 0.5
    min_bbox_size: 80
    max_blur_variance: 100

# ============================================================
# VISUALIZATION
# ============================================================
visualization:
  enabled: true
  
  # Bounding box colors
  colors:
    registered: [0, 255, 0]      # GREEN for registered IDs (1, 2, 3, ...)
    unknown: [0, 0, 255]          # RED for unknown (UNK1, UNK2, ...)
    intruder: [0, 0, 255]         # RED for intruders
    processing: [255, 165, 0]     # ORANGE for processing (before face detected)
  
  # Text labels
  labels:
    show_id: true                 # Show ID/UNK number
    show_camera: true             # Show camera name
    show_confidence: true         # Show match confidence
    show_status: true             # Show status (REGISTERED/UNKNOWN/INTRUDER)
  
  # Mosaic preview
  mosaic:
    enabled: true
    layout: "2x2"
    cell_width: 640
    cell_height: 480
  
  # Font
  font_scale: 0.7
  font_thickness: 2
  
  # Status text overlay
  status_overlay:
    cam1: "REGISTRATION POINT"
    cam2: "PARKING - VERIFICATION"
    cam3: "ELEVATOR - VERIFICATION"
    cam4: "ROOM - RESTRICTED AREA"

# ============================================================
# OUTPUT
# ============================================================
output:
  out_dir: "D:/HAVEN/backend/outputs/hierarchical"
  
  # Video recording
  write_video: true
  video_codec: "mp4v"
  video_fps: 30
  per_camera_output: true
  mosaic_output: true
  
  # Database
  database:
    enabled: true
    path: "D:/HAVEN/backend/haven_hierarchical.db"
    save_embeddings: true
    save_snapshots: true
    
    # Tables
    tables:
      registered_persons: true    # Registered IDs from cam1
      unknown_detections: true    # Unknown persons (UNK)
      intruder_alerts: true       # Intruder detections (cam4)
      tracking_events: true       # All tracking events
  
  # Logging
  logging:
    enabled: true
    level: "INFO"
    log_file: "D:/HAVEN/backend/logs/hierarchical_security.log"
    console_output: true
    
    # Event logging
    log_events:
      registration: true          # Cam1 registration events
      verification_success: true  # Successful verifications
      verification_failed: true   # Unknown persons detected
      intruder_alert: true        # Intruder alerts
      spatiotemporal_filter: true
  
  # Alerts
  alerts:
    unknown_person:
      enabled: true
      cameras: [2, 3]  # Alert on cam2 and cam3
      sound: false
      
    intruder:
      enabled: true
      cameras: [4]  # Alert on cam4
      sound: true  # Beep sound
      email: false  # TODO: email notification

# ============================================================
# PERFORMANCE
# ============================================================
performance:
  batch_detection: false
  batch_size: 4
  use_multiprocessing: false
  num_workers: 4
  adaptive_skip: false
  target_fps: 30

# ============================================================
# DEBUG
# ============================================================
debug:
  enabled: false
  save_debug_frames: false
  debug_frames_dir: "D:/HAVEN/backend/outputs/debug"
  print_similarity_scores: true
  print_registry_state: false
  profile_performance: false

