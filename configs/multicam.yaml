# HAVEN Multi-Camera ReID Configuration
# Version: 2.0 - Dual Master Camera Support

# ============================================================
# DATA SOURCE CONFIGURATION
# ============================================================
data:
  # Root directory containing camera folders
  # Structure: data_root/cam1/*.mp4, data_root/cam2/*.mp4, etc.
  data_root: "D:/HAVEN/backend/data/multi-camera"
  
  # Camera definitions
  cameras:
    - id: 1
      name: "cam1"
      enabled: true
      source_type: "video_folder"  # Options: video_folder | video_file | rtsp
      path: "cam1"  # Points to folder D:/HAVEN/backend/data/multi-camera/cam1
      pattern: "*.mp4"  # Pattern for multiple video chunks
      fps_override: null  # null = auto-detect
      start_offset_ms: 0  # Delay start time for sync
      resize_width: 640
      skip_frames: 0  # 0 = process every frame, 1 = every other frame
      
    - id: 2
      name: "cam2"
      enabled: true
      source_type: "video_folder"
      path: "cam2"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0
      
    - id: 3
      name: "cam3"
      enabled: true
      source_type: "video_folder"
      path: "cam3"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0
      
    - id: 4
      name: "cam4"
      enabled: true
      source_type: "video_folder"
      path: "cam4"
      pattern: "*.mp4"
      fps_override: null
      start_offset_ms: 0
      resize_width: 640
      skip_frames: 0

# ============================================================
# MASTER CAMERA CONFIGURATION (CRITICAL!)
# ============================================================
master_cameras:
  # List of camera IDs that can create NEW global IDs
  # IMPORTANT: Only cameras in this list can assign new global IDs
  # Other cameras can only MATCH to existing IDs
  ids: [1, 2]  # cam1 and cam2 are MASTERS
  
  # Tie-breaker logic when multiple masters create ID simultaneously
  # Options: "camera_id" (lower ID wins) | "timestamp" (earlier wins)
  conflict_resolution: "camera_id"

# ============================================================
# CAMERA GRAPH - Spatiotemporal Constraints
# ============================================================
camera_graph:
  # Define transition times between cameras (in seconds)
  # Format: cam_from -> cam_to: {min_time, max_time}
  transitions:
    1:  # cam1
      2: {min_time: 5, max_time: 30}
      3: {min_time: 10, max_time: 60}
      4: {min_time: 15, max_time: 90}
    2:  # cam2
      1: {min_time: 5, max_time: 30}
      3: {min_time: 15, max_time: 90}
      4: {min_time: 10, max_time: 60}
    3:  # cam3
      1: {min_time: 10, max_time: 60}
      2: {min_time: 15, max_time: 90}
      4: {min_time: 5, max_time: 30}
    4:  # cam4
      1: {min_time: 15, max_time: 90}
      2: {min_time: 10, max_time: 60}
      3: {min_time: 5, max_time: 30}

# ============================================================
# DETECTION & TRACKING
# ============================================================
detection:
  yolo:
    model_path: "backend/models/yolov11n.pt"
    conf_threshold: 0.5
    iou_threshold: 0.45
    device: "cuda"  # Options: cuda | cpu
    img_size: 640
    classes: [0]  # 0 = person class only
    
tracking:
  tracker_type: "bytetrack"  # Options: bytetrack | botsort
  min_tracklet_frames: 5  # Minimum frames to consider a tracklet valid
  max_age: 30  # Maximum frames to keep lost tracks
  min_hits: 3  # Minimum detections before confirmed
  iou_threshold: 0.3

# ============================================================
# REID CONFIGURATION (CRITICAL!)
# ============================================================
reid:
  # Feature extraction
  features:
    face:
      enabled: false  # TODO: Implement face extractor
      model_path: "models/arcface_r100.pth"
      weight: 1.0
      
    gait:
      enabled: false  # TODO: Implement gait extractor
      sequence_length: 15
      weight: 0.8
      
    appearance:
      enabled: true  # Using YOLO features for now
      model_path: null  # null = use YOLO features
      weight: 0.6
  
  # Similarity thresholds (Two-threshold decision)
  thresholds:
    accept: 0.75  # T_high: >= this = confident match to existing ID
    reject: 0.50  # T_low: <= this = definitely new person
    margin: 0.15  # Required margin between 1st and 2nd candidate
    
    # Per-signal thresholds
    face_similarity: 0.60
    gait_similarity: 0.70
    appearance_similarity: 0.50
  
  # Similarity metric
  similarity_metric: "cosine"  # Options: cosine | euclidean
  
  # Embedding update strategy
  update_method: "ema"  # Options: ema | average | max_quality
  ema_alpha: 0.3  # For EMA: new = alpha * new + (1-alpha) * old
  
  # Quality gating
  quality:
    min_tracklet_frames: 5  # Minimum frames before attempting ReID
    min_quality_score: 0.5  # Overall quality threshold
    min_bbox_size: 80  # Minimum bbox width/height in pixels
    max_blur_variance: 100  # Maximum Laplacian variance (higher = sharper)
  
  # Multi-prototype memory
  multi_prototype:
    enabled: true
    memory_size: 10  # Keep top-N embeddings per global ID
    ttl_seconds: 7200  # Time-to-live for old embeddings (2 hours)
  
  # ID reuse policy
  reuse_window: 7200  # Seconds before an ID can be reused (2 hours)
  
  # Memory settings (for GlobalIDManager)
  memory:
    max_prototypes: 10
    ema_alpha: 0.3
  
  # Cooldown to prevent rapid ID switching
  cooldown:
    enabled: true
    duration_seconds: 5  # Once matched, wait 5s before re-matching

# ============================================================
# SYNCHRONIZATION
# ============================================================
sync:
  # Synchronization strategy
  # Options: frame_index | timestamp | none
  method: "frame_index"  # Use frame index for videos with same FPS
  
  # Global time step (for timestamp-based sync)
  time_step_ms: 33  # ~30 FPS
  
  # Buffer settings
  max_buffer_frames: 10  # Max frames to buffer per camera

# ============================================================
# YOLO MODEL (for pose detection and tracking)
# ============================================================
yolo:
  model: "yolo11n-pose.pt"
  pose_model: "yolo11n-pose.pt"
  conf_threshold: 0.4
  iou_threshold: 0.45

# ============================================================
# DISPLAY (for compatibility with runner code)
# ============================================================
display:
  width: 640
  height: 480
  window_name: "HAVEN Multi-Camera"
  mosaic: true
  show_skeleton: true

# ============================================================
# VISUALIZATION
# ============================================================
visualization:
  enabled: true
  show_bbox: true
  show_local_track_id: true
  show_global_id: true
  show_confidence_score: true
  show_match_reason: true  # Show why ID was assigned (NEW/MATCHED/TEMP)
  
  # Mosaic preview (all cameras in one window)
  mosaic:
    enabled: true
    layout: "2x2"  # Options: 1x2, 2x2, 1x3, 1x4
    cell_width: 640
    cell_height: 480
  
  # Colors
  colors:
    new_id: [0, 255, 0]  # Green for new IDs from master cameras
    matched_id: [0, 255, 255]  # Cyan for matched IDs
    temp_id: [255, 165, 0]  # Orange for temporary IDs (non-master)
    wait_master: [128, 128, 128]  # Gray for waiting master confirmation
  
  # Text display
  font_scale: 0.6
  font_thickness: 2

# ============================================================
# OUTPUT
# ============================================================
output:
  # Output directory
  out_dir: "D:/HAVEN/backend/outputs/multicam"
  dir: "D:/HAVEN/backend/outputs/multicam"
  
  # Video recording
  write_video: true
  video_codec: "mp4v"  # Options: mp4v | avc1 | XVID
  video_fps: 30
  
  # Per-camera output videos
  per_camera_output: true  # Save cam1_out.mp4, cam2_out.mp4, etc.
  
  # Combined mosaic output
  mosaic_output: true  # Save mosaic_out.mp4
  
  # Database
  database:
    enabled: true
    path: "D:/HAVEN/backend/haven_reid.db"
    save_embeddings: true
    save_snapshots: true
  
  # Logging
  logging:
    enabled: true
    level: "INFO"  # Options: DEBUG | INFO | WARNING | ERROR
    log_file: "D:/HAVEN/backend/logs/multicam_reid.log"
    console_output: true
    
    # Detailed event logging
    log_events:
      new_id_created: true
      id_matched: true
      id_rejected: true
      spatiotemporal_filter: true

# ============================================================
# PERFORMANCE
# ============================================================
performance:
  # Batch processing
  batch_detection: false  # Batch detections across cameras (if GPU memory allows)
  batch_size: 4
  
  # Threading
  use_multiprocessing: false  # Use multiprocessing for camera streams
  num_workers: 4
  
  # Frame skipping
  adaptive_skip: false  # Adaptively skip frames based on CPU load
  target_fps: 30  # Target processing FPS

# ============================================================
# DEBUG & TESTING
# ============================================================
debug:
  enabled: false
  save_debug_frames: false
  debug_frames_dir: "D:/HAVEN/backend/outputs/debug"
  print_similarity_scores: true  # Print all similarity scores
  print_gallery_state: false  # Print gallery contents periodically
  profile_performance: false  # Profile execution time

