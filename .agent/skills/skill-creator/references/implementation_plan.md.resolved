# Zone Intrusion + Dangerous Object Detection

## Problem Description

Mở rộng hệ thống HAVEN hiện tại (pose detection + ADL) để thêm:
1. **Vùng cấm (Zone Intrusion)**: Cảnh báo khi người đi vào vùng được định nghĩa trước
2. **Vật nguy hiểm (Dangerous Object)**: Phát hiện dao, kéo, súng, thuốc, lửa, v.v.

## User Review Required

> [!IMPORTANT]
> **Lựa chọn Model cho Object Detection**
> - Option A: Dùng YOLOv8/11 pretrained COCO (80 classes - có knife, scissors nhưng không có gun, fire)
> - Option B: Dùng custom model trained trên dataset riêng (cần dữ liệu + training)
> - Option C: Dùng multi-model (COCO + fire detection + weapon detection)

> [!WARNING]
> **Hiệu năng**: Chạy thêm 1 model object detection sẽ giảm FPS khoảng 30-50% (tùy GPU/CPU)

## Proposed Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Input Frame                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
    ┌─────────────┴─────────────┐
    │                           │
    ▼                           ▼
┌──────────────┐         ┌──────────────────┐
│ Pose Model   │         │ Object Detection │
│ (yolo11s-    │         │ (yolo11s.pt or   │
│  pose.pt)    │         │  custom.pt)      │
└──────┬───────┘         └────────┬─────────┘
       │                          │
       ▼                          ▼
┌──────────────┐         ┌──────────────────┐
│ ADL Analysis │         │ Object Filtering │
│ - Posture    │         │ - Dangerous only │
│ - Fall       │         │ - knife, scissors│
│ - Hand raise │         │ - fire, gun, etc │
└──────┬───────┘         └────────┬─────────┘
       │                          │
       ▼                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Zone Intrusion Check                     │
│    - Person bbox inside forbidden zone? → ALERT             │
│    - Dangerous object detected? → ALERT                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Proposed Changes

### Component 1: Configuration Extension

#### [MODIFY] [shared_config.py](file:///d:/HAVEN/backend/shared_config.py)

Thêm các config mới:

```python
# ZONE INTRUSION SETTINGS
ZONE_ENABLED = bool(os.getenv("ZONE_ENABLED", "False") == "True")
FORBIDDEN_ZONES = [
    # Format: (x1, y1, x2, y2) as percentages of frame (0.0-1.0)
    # Example: top-right corner of frame
    {"name": "Kitchen", "coords": (0.6, 0.0, 1.0, 0.4)},
]

# DANGEROUS OBJECT DETECTION
OBJECT_DETECTION_ENABLED = bool(os.getenv("OBJECT_DETECTION_ENABLED", "False") == "True")
OBJECT_MODEL_PATH = str(MODELS_DIR / "yolo11s.pt")  # Standard COCO model
DANGEROUS_OBJECTS = ["knife", "scissors", "fire", "gun"]  # Classes to alert
```

---

### Component 2: Zone Intrusion Module

#### [NEW] [zone_intrusion.py](file:///d:/HAVEN/backend/src/adl/zone_intrusion.py)

```python
class ZoneManager:
    """Quản lý các vùng cấm và kiểm tra xâm nhập"""
    
    def __init__(self, zones: list, frame_width: int, frame_height: int):
        self.zones = []
        for z in zones:
            # Convert percentage to pixel coordinates
            x1 = int(z["coords"][0] * frame_width)
            y1 = int(z["coords"][1] * frame_height)
            x2 = int(z["coords"][2] * frame_width)
            y2 = int(z["coords"][3] * frame_height)
            self.zones.append({
                "name": z["name"],
                "coords": (x1, y1, x2, y2)
            })
    
    def check_intrusion(self, person_bbox) -> str | None:
        """Kiểm tra person có trong vùng cấm không"""
        px1, py1, px2, py2 = person_bbox
        person_center = ((px1 + px2) / 2, (py1 + py2) / 2)
        
        for zone in self.zones:
            zx1, zy1, zx2, zy2 = zone["coords"]
            if zx1 <= person_center[0] <= zx2 and zy1 <= person_center[1] <= zy2:
                return zone["name"]
        return None
    
    def draw_zones(self, frame):
        """Vẽ các vùng cấm lên frame"""
        for zone in self.zones:
            x1, y1, x2, y2 = zone["coords"]
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 2)
            cv2.putText(frame, f"FORBIDDEN: {zone['name']}", (x1, y1-10), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 255), 2)
```

---

### Component 3: Dangerous Object Detection

#### [NEW] [object_detector.py](file:///d:/HAVEN/backend/src/adl/object_detector.py)

```python
class DangerousObjectDetector:
    """Phát hiện vật nguy hiểm từ COCO model"""
    
    # COCO class mapping (relevant dangerous objects)
    COCO_DANGEROUS = {
        43: "knife",      # COCO class 43
        76: "scissors",   # COCO class 76
    }
    
    def __init__(self, model_path: str, dangerous_classes: list):
        self.model = YOLO(model_path)
        self.dangerous_classes = dangerous_classes
    
    def detect(self, frame) -> list:
        """Detect dangerous objects in frame"""
        results = self.model(frame, verbose=False, conf=0.3)[0]
        dangerous_found = []
        
        if results.boxes is not None:
            for box, cls, conf in zip(
                results.boxes.xyxy.cpu().numpy(),
                results.boxes.cls.cpu().numpy(),
                results.boxes.conf.cpu().numpy()
            ):
                class_name = self.model.names[int(cls)]
                if class_name in self.dangerous_classes:
                    dangerous_found.append({
                        "class": class_name,
                        "bbox": box.tolist(),
                        "conf": float(conf)
                    })
        
        return dangerous_found
```

---

### Component 4: Integration vào Main Script

#### [MODIFY] [pose-adl.py](file:///d:/HAVEN/backend/test-video/pose-adl.py)

Thêm vào main loop:

```python
# Initialize (sau khi load pose model)
if ZONE_ENABLED:
    zone_manager = ZoneManager(FORBIDDEN_ZONES, frame_width, frame_height)

if OBJECT_DETECTION_ENABLED:
    object_detector = DangerousObjectDetector(OBJECT_MODEL_PATH, DANGEROUS_OBJECTS)

# Trong main loop, sau khi detect pose:

# Check zone intrusion
if ZONE_ENABLED:
    zone_manager.draw_zones(frame)
    for det in tracked:
        zone_name = zone_manager.check_intrusion(det['bbox'])
        if zone_name:
            state.add_event(f"ZONE_INTRUSION: {zone_name}")

# Check dangerous objects
if OBJECT_DETECTION_ENABLED:
    dangerous = object_detector.detect(frame)
    for obj in dangerous:
        x1, y1, x2, y2 = map(int, obj['bbox'])
        cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 3)
        cv2.putText(frame, f"DANGER: {obj['class']}", (x1, y1-10),
                   FONT_FACE, 0.7, (0, 0, 255), 2)
```

---

### Component 5: Environment Variables

#### [MODIFY] [.env](file:///d:/HAVEN/.env)

```ini
# Zone Intrusion Detection
ZONE_ENABLED=False

# Dangerous Object Detection
OBJECT_DETECTION_ENABLED=False
OBJECT_MODEL_PATH=backend/models/yolo11s.pt
```

---

## Verification Plan

### Automated Tests
1. Chạy [video-pose-adl.bat](file:///d:/HAVEN/video-pose-adl.bat) với video có người đi vào vùng cấm
2. Chạy với video có dao/kéo xuất hiện
3. Kiểm tra FPS trước và sau khi bật object detection

### Manual Verification
1. Vẽ vùng cấm trên màn hình (rectangle đỏ)
2. Xác nhận alert xuất hiện khi person vào vùng
3. Xác nhận dangerous object được highlight đỏ

---

## Decision Required

1. **Object Detection Model**: Dùng COCO pretrained hay custom model?
2. **Dangerous Objects List**: Những class nào cần detect? (knife, scissors, fire, gun, medication, ...)
3. **Zone Configuration**: Định nghĩa zones qua UI hay file config?
4. **Alert Method**: Chỉ hiển thị trên video hay cần gửi notification?
